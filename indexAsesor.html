<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Asesor√≠as</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      margin: 0;
      padding: 0;
      background-color: white;
      font-family: Arial, sans-serif;
    }

    .header {
      background-color: #CE93D8;
      color: white;
      padding: 15px;
      font-size: 20px;
      font-weight: bold;
    }

    .container {
      padding: 20px;
      max-width: 800px;
      margin: 0 auto;
    }

    .title {
      font-size: 22px;
      font-weight: bold;
      color: #622C71;
      margin-bottom: 10px;
    }

    .buttons-container {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }

    .buttons-container button {
      background-color: #FFE699;
      border: none;
      border-radius: 50%;
      width: 35px;
      height: 35px;
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .card {
      display: flex;
      background-color: #CE93D8;
      color: white;
      margin-bottom: 10px;
      border-radius: 8px;
      overflow: hidden;
      position: relative;
    }

    .card img {
      width: 40%;
      object-fit: cover;
    }

    .card-info {
      padding: 10px;
      width: 60%;
    }

    .card-info h3 {
      color: #FFE699;
      margin: 0 0 5px 0;
    }

    .card-info p {
      margin: 2px 0;
    }

    .delete-btn {
      position: absolute;
      top: 5px;
      right: 5px;
      background-color: #ff5252;
      color: white;
      border: none;
      border-radius: 50%;
      width: 25px;
      height: 25px;
      font-size: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Estilos para el buscador */
    .search-container {
      margin-bottom: 15px;
    }

    .search-container input {
      padding: 8px;
      border-radius: 4px;
      border: 1px solid #ddd;
      width: 200px;
    }
  </style>
</head>
<body>
  <div class="header"> Bienvenido @asesor</div>

  <div class="container">
    <!-- Asesor√≠as -->
    <div class="section">
      <div class="title">Asesor√≠as</div>
      <div class="buttons-container">
        <button data-bs-toggle="modal" data-bs-target="#asesoriaModal">+</button>
        <button onclick="mostrarBuscador()">üîç</button>
      </div>
      <div class="search-container" id="searchContainer" style="display: none;">
        <input type="text" id="searchInput" placeholder="Buscar asesor√≠a...">
        <button onclick="buscarAsesoria()">Buscar</button>
      </div>
      <div id="asesorias-container"></div>
    </div>
  </div>

  <!-- Modal para agregar asesor√≠as -->
  <div class="modal fade" id="asesoriaModal" tabindex="-1" aria-labelledby="asesoriaModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="asesoriaModalLabel">Nueva Asesor√≠a</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
        <div class="modal-body">
          <form id="asesoriaForm">
            <div class="mb-3">
              <label class="form-label">Materia</label>
              <input type="text" class="form-control" id="materiaInput" required>
            </div>
            <div class="mb-3">
              <label class="form-label">D√≠a</label>
              <select class="form-select" id="diaInput" required>
                <option value="Lunes">Lunes</option>
                <option value="Martes">Martes</option>
                <option value="Miercoles">Mi√©rcoles</option>
                <option value="Jueves">Jueves</option>
                <option value="Viernes">Viernes</option>
                <option value="S√°bado">S√°bado</option>
                <option value="Domingo">Domingo</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Hora de inicio</label>
              <input type="time" class="form-control" id="inicioInput" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Hora de fin</label>
              <input type="time" class="form-control" id="finInput" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Modalidad</label>
              <select class="form-select" id="modalidadInput" required>
                <option value="presencial">Presencial</option>
                <option value="virtual">Virtual</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Descripci√≥n</label>
              <textarea class="form-control" id="descripcionInput"></textarea>
            </div>
            <div class="mb-3">
              <label class="form-label">Imagen</label>
              <input type="file" class="form-control" id="imagenInput" accept="image/*">
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-primary" onclick="guardarAsesoria()">Guardar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS y dependencias -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    // Variable global para almacenar las asesor√≠as
    let asesorias = [];
    let usuarioActual = null;

    // Cargar asesor√≠as al iniciar la p√°gina
    document.addEventListener('DOMContentLoaded', async() => {
      await cargarUsuarioActual();
      await cargarAsesorias();
    });

    async function cargarUsuarioActual() {
        try {
            const response = await fetch('/api/usuario-actual', {
                credentials: 'include'
            });
            
            if (!response.ok) {
                throw new Error('Error al obtener usuario');
            }
            
            usuarioActual = await response.json();
            actualizarHeader();
        } catch (error) {
            console.error("Error al cargar usuario:", error);
            document.querySelector('.header').textContent = 'üë§ Bienvenido Asesor';
        }
    }

    function actualizarHeader() {
        if (usuarioActual && usuarioActual.nombre) {
            const header = document.querySelector('.header');
            header.innerHTML = `üë§ Bienvenido ${usuarioActual.nombre}`;
            
            // Opcional: agregar bot√≥n de cerrar sesi√≥n
            header.innerHTML += `
                <button onclick="cerrarSesion()" 
                        style="float: right; background: none; border: none; color: white; cursor: pointer;">
                    Cerrar sesi√≥n
                </button>`;
        }
    }


    // Funci√≥n para cargar asesor√≠as desde el servidor
    async function cargarAsesorias() {
      const contenedor = document.getElementById("asesorias-container");
      contenedor.innerHTML = '<p class="text-center">Cargando asesor√≠as...</p>';

      try {
        const response = await fetch('http://localhost:8000/api/asesorias', {
          headers: {
            'Content-Type': 'application/json',
          },
          credentials: 'include'
        });
        
        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(errorText || `Error ${response.status}`);
        }
        
        const data = await response.json();
        
        if (!data || data.length === 0) {
          contenedor.innerHTML = '<p class="text-center">No hay asesor√≠as registradas a√∫n</p>';
          return;
        }
        
        // Guarda en localStorage como respaldo
        localStorage.setItem('asesoriasBackup', JSON.stringify(data));
        renderizarAsesorias(data);
        
      } catch (error) {
        console.error("Error detallado:", error);
        
        // Intenta con datos de localStorage
        const backup = localStorage.getItem('asesoriasBackup');
        if (backup) {
          try {
            renderizarAsesorias(JSON.parse(backup));
            return;
          } catch (e) {
            console.error("Error al parsear backup:", e);
          }
        }
        
        // Muestra datos de ejemplo con imagen local
        contenedor.innerHTML = `
          <div class="card">
            <img src="images/placeholder.jpg" alt="Ejemplo">
            <div class="card-info">
              <h3>EJEMPLO DE ASESOR√çA</h3>
              <p><strong>Error:</strong> ${error.message}</p>
              <p>No se pudo conectar al servidor. Mostrando datos locales.</p>
            </div>
          </div>
        `;
      }
    }

// Funci√≥n de respaldo para mostrar datos de ejemplo

    // Funci√≥n para renderizar las asesor√≠as en el DOM
    function renderizarAsesorias(asesorias) {
      const contenedor = document.getElementById("asesorias-container");
      contenedor.innerHTML = "";
      
      asesorias.forEach((a) => {
        contenedor.innerHTML += `
          <div class="card">
            <img src="${a.imagen || 'https://via.placeholder.com/150'}" alt="${a.materia}">
            <div class="card-info">
              <button class="delete-btn" onclick="eliminarAsesoria('${a._id}')">‚úï</button>
              <h3>${a.materia}</h3>
              <p><strong>Horario:</strong> ${a.dia} ${a.inicio} - ${a.fin}</p>
              <p><strong>Modalidad:</strong> ${a.modalidad}</p>
              <p><strong>Estado:</strong> ${a.estado}</p>
              ${a.descripcion ? `<p><strong>Descripci√≥n:</strong> ${a.descripcion}</p>` : ''}
            </div>
          </div>`;
      });
    }

    // Funci√≥n para guardar una nueva asesor√≠a
    async function guardarAsesoria() {
      const formData = new FormData();
      const imagenInput = document.getElementById('imagenInput');
      
      // Aseg√∫rate de que todos los campos requeridos est√©n presentes
      const materia = document.getElementById('materiaInput').value;
      const dia = document.getElementById('diaInput').value;
      const inicio = document.getElementById('inicioInput').value;
      const fin = document.getElementById('finInput').value;
      const modalidad = document.getElementById('modalidadInput').value;
      
      if (!materia || !dia || !inicio || !fin || !modalidad) {
        alert("Por favor complete todos los campos requeridos");
        return;
      }

      // Usa el mismo nombre de campos que espera el backend
      formData.append('ID_asesor', '1'); // Temporal - deber√≠as obtenerlo de la sesi√≥n
      formData.append('materia', materia);
      formData.append('descripcion', document.getElementById('descripcionInput').value);
      formData.append('modalidad', modalidad);
      formData.append('dia', dia);
      formData.append('inicio', inicio);
      formData.append('fin', fin);
      
      if (imagenInput.files[0]) {
        formData.append('imagen', imagenInput.files[0]);
      }

      try {
        const response = await fetch('http://localhost:8000/api/asesorias', {
          method: 'POST',
          body: formData,
          credentials: 'include'
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || errorData.message || 'Error al guardar');
        }
        
        const result = await response.json();
        console.log("Asesor√≠a creada:", result);

        await cargarAsesorias();
        
        // Actualiza la lista sin recargar
        const asesoriasActuales = JSON.parse(localStorage.getItem('asesoriasBackup')) || [];
        asesoriasActuales.unshift(result); // Agrega la nueva asesor√≠a al inicio
        localStorage.setItem('asesoriasBackup', JSON.stringify(asesoriasActuales));
        renderizarAsesorias(asesoriasActuales);
        
        
        // Limpiar y cerrar modal
        document.getElementById('asesoriaForm').reset();
        bootstrap.Modal.getInstance(document.getElementById('asesoriaModal')).hide();
        
      } catch (error) {
        console.error('Error:', error);
        alert(`Error al guardar: ${error.message}`);
      }
    }

    // Funci√≥n para eliminar una asesor√≠a
    async function eliminarAsesoria(id) {
      if (!confirm("¬øEst√°s seguro de que quieres eliminar esta asesor√≠a?")) return;
      
      try {
        const response = await fetch(`http://localhost:8000/api/asesorias/${id}`, {
          method: 'DELETE',
          credentials: 'include'
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'Error al eliminar');
        }

        // Actualiza la lista local sin recargar
        const contenedor = document.getElementById("asesorias-container");
        const cards = contenedor.querySelectorAll('.card');
        
        cards.forEach(card => {
          if (card.querySelector('.delete-btn').onclick.toString().includes(id)) {
            card.remove(); // Elimina visualmente la tarjeta
          }
        });
        
        // Actualiza los datos en localStorage
        const asesoriasActuales = JSON.parse(localStorage.getItem('asesoriasBackup') || []);
        const nuevasAsesorias = asesoriasActuales.filter(a => a._id !== id);
        localStorage.setItem('asesoriasBackup', JSON.stringify(nuevasAsesorias));
        
      } catch (error) {
        console.error('Error:', error);
        alert(`Error al eliminar: ${error.message}`);
      }
    }

    function mostrarDatosDeEjemplo() {
      console.log("Mostrando datos de ejemplo");
      const contenedor = document.getElementById("asesorias-container");
      contenedor.innerHTML = `
      <div class="card">
        <div class="placeholder-img" style="width:40%;height:100%;display:flex;align-items:center;justify-content:center;background:#f0f0f0;">
          Sin imagen
        </div>
        <div class="card-info">
          <h3>EJEMPLO DE ASESOR√çA</h3>
          <p><strong>Error:</strong> ${error.message}</p>
          <p>No se pudo conectar al servidor</p>
        </div>
      </div>
`;
    }

    // Funci√≥n para mostrar/ocultar el buscador
    function mostrarBuscador() {
      const searchContainer = document.getElementById('searchContainer');
      searchContainer.style.display = searchContainer.style.display === 'none' ? 'block' : 'none';
    }

    // Funci√≥n para buscar asesor√≠as
    function buscarAsesoria() {
      const consulta = document.getElementById('searchInput').value.toLowerCase();
      if (!consulta) {
        renderizarAsesorias(asesorias);
        return;
      }
      
      const resultado = asesorias.filter(a => 
        a.materia.toLowerCase().includes(consulta) ||
        (a.descripcion && a.descripcion.toLowerCase().includes(consulta))
      );
      
      renderizarAsesorias(resultado);
    }
  </script>
</body>
</html>