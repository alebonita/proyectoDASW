<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Asesor√≠as</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      margin: 0;
      padding: 0;
      background-color: white;
      font-family: Arial, sans-serif;
    }

    .header {
      background-color: #CE93D8;
      color: white;
      padding: 15px;
      font-size: 20px;
      font-weight: bold;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .container {
      padding: 20px;
      max-width: 800px;
      margin: 0 auto;
    }

    .title {
      font-size: 22px;
      font-weight: bold;
      color: #622C71;
      margin-bottom: 10px;
    }

    .buttons-container {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }

    .buttons-container button {
      background-color: #FFE699;
      border: none;
      border-radius: 50%;
      width: 35px;
      height: 35px;
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .card {
      display: flex;
      flex-direction: row; /* Expl√≠citamente horizontal */
      background-color: #CE93D8;
      color: white;
      margin-bottom: 20px;
      border-radius: 8px;
      overflow: hidden;
      position: relative;
      min-height: 150px; /* Altura m√≠nima para la tarjeta */
      box-shadow: 0 4px 8px rgba(0,0,0,0.1); /* Sombra suave */
    }

    .card img {
      width: 40%;
      height: 100%;
      object-fit: cover;
      flex-shrink: 0; /* Evita que la imagen se encoja */
    }

    .card-info {
      padding: 15px;
      width: 60%;
      text-align: left; /* Alineaci√≥n izquierda expl√≠cita */
      display: flex;
      flex-direction: column;
      justify-content: center; /* Centra verticalmente el contenido */
    }

    .card-info h3 {
      color: #FFE699;
      margin: 0 0 5px 0;
    }

    .card-info p {
      margin: 2px 0;
    }

    .delete-btn {
      position: absolute;
      top: 5px;
      right: 5px;
      background-color: #ff5252;
      color: white;
      border: none;
      border-radius: 50%;
      width: 25px;
      height: 25px;
      font-size: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Estilos para el buscador */
    .search-container {
      margin-bottom: 15px;
    }

    .search-container input {
      padding: 8px;
      border-radius: 4px;
      border: 1px solid #ddd;
      width: 200px;
    }
    
    /* Estilos para el calendario */
    .calendar {
      border-radius: 10px;
      overflow: hidden;
      width: 100%;
      margin-bottom: 20px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .calendar-header {
      background-color: #CE93D8;
      color: white;
      text-align: center;
      padding: 10px;
      font-weight: bold;
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
      padding: 10px;
      text-align: center;
      background-color: white;
    }

    .day-name {
      font-weight: bold;
      padding: 5px;
    }

    .day {
      padding: 10px;
      border-radius: 50%;
    }

    .marked {
      background-color: #FFE699;
      border-radius: 50%;
    }

    /* INICIO: Estilos espec√≠ficos para el modal del men√∫ */
    .menu-btn {
      font-size: 24px;
      cursor: pointer;
      background: none;
      border: none;
      color: white;
    }

    .menu-modal {
      display: none;
      position: fixed;
      top: 0;
      right: 0;
      width: 250px;
      background-color: white;
      box-shadow: -2px 0 10px rgba(0,0,0,0.2);
      height: 100vh;
      z-index: 1000;
      padding: 20px;
      box-sizing: border-box;
      transform: translateX(100%); /* Comienza fuera de la pantalla */
      transition: transform 0.3s ease-in-out;
    }
    
    .menu-modal.show {
      transform: translateX(0); /* Se desliza hacia la vista */
    }

    .menu-modal-content {
      margin-top: 20px;
    }

    .menu-modal-content p {
      margin: 10px 0;
      color: #622C71;
    }

    .logout-btn {
      background-color: #622C71;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 20px;
      width: 100%;
    }

    .menu-close-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 20px;
      cursor: pointer;
    }
    /* FIN: Estilos espec√≠ficos para el modal del men√∫ */
  </style>
</head>
<body>
  <div class="header">
    <span id="userWelcome">üë§ Bienvenido @asesor</span>
    <button class="menu-btn" onclick="toggleModal()">‚ò∞</button>
  </div>

  <!-- Modal del men√∫ (nuevo) -->
  <div id="accountModal" class="menu-modal">
    <span class="menu-close-btn" onclick="toggleModal()">&times;</span>
    <div class="menu-modal-content">
      <h3>Informaci√≥n de la cuenta</h3>
      <p><strong>Nombre:</strong> <span id="userName">Cargando...</span></p>
      <p><strong>Correo:</strong> <span id="userEmail">Cargando...</span></p>
      <p><strong>Tipo de cuenta:</strong> <span id="userType">Cargando...</span></p>
      <button class="logout-btn" onclick="cerrarSesion()">Cerrar sesi√≥n</button>
    </div>
  </div>

  <div class="container">
    <!-- Calendario -->
    <div class="section">
      <div class="title">Calendario</div>
      <div class="calendar">
        <div class="calendar-header">CALENDARIO</div>
        <div id="calendar-grid" class="calendar-grid"></div>
      </div>
    </div>

    <!-- Asesor√≠as -->
    <div class="section">
      <div class="title">Asesor√≠as</div>
      <div class="buttons-container">
        <button data-bs-toggle="modal" data-bs-target="#asesoriaModal">+</button>
        <button onclick="mostrarBuscador()">üîç</button>
      </div>
      <div class="search-container" id="searchContainer" style="display: none;">
        <input type="text" id="searchInput" placeholder="Buscar asesor√≠a...">
        <button onclick="buscarAsesoria()">Buscar</button>
      </div>
      <div id="asesorias-container"></div>
    </div>
  </div>

  <!-- Modal para agregar asesor√≠as (ya existente) -->
  <div class="modal fade" id="asesoriaModal" tabindex="-1" aria-labelledby="asesoriaModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="asesoriaModalLabel">Nueva Asesor√≠a</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
        <div class="modal-body">
          <form id="asesoriaForm">
            <div class="mb-3">
              <label class="form-label">Materia</label>
              <input type="text" class="form-control" id="materiaInput" required>
            </div>
            <div class="mb-3">
              <label class="form-label">D√≠a</label>
              <select class="form-select" id="diaInput" required>
                <option value="Lunes">Lunes</option>
                <option value="Martes">Martes</option>
                <option value="Miercoles">Mi√©rcoles</option>
                <option value="Jueves">Jueves</option>
                <option value="Viernes">Viernes</option>
                <option value="S√°bado">S√°bado</option>
                <option value="Domingo">Domingo</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Hora de inicio</label>
              <input type="time" class="form-control" id="inicioInput" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Hora de fin</label>
              <input type="time" class="form-control" id="finInput" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Modalidad</label>
              <select class="form-select" id="modalidadInput" required>
                <option value="presencial">Presencial</option>
                <option value="virtual">Virtual</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Descripci√≥n</label>
              <textarea class="form-control" id="descripcionInput"></textarea>
            </div>
            <div class="mb-3">
              <label class="form-label">Imagen</label>
              <input type="file" class="form-control" id="imagenInput" accept="image/*">
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-primary" onclick="guardarAsesoria()">Guardar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS y dependencias -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    // Variable global para almacenar las asesor√≠as
    let asesorias = [];
    let usuarioActual = null;
    const API_URL = 'http://localhost:8000';

    // Cargar asesor√≠as al iniciar la p√°gina
    document.addEventListener('DOMContentLoaded', async() => {
      try {
        await cargarUsuarioActual();
        await cargarAsesorias();
        renderizarCalendario();
      } catch (error) {
        console.error("Error al inicializar:", error);
        alert("Error al inicializar la p√°gina. Verifica la conexi√≥n con el servidor.");
      }
    });

    async function cargarUsuarioActual() {
      try {
        // Intentar cargar los datos del usuario desde localStorage
        const usuarioData = localStorage.getItem('usuario');
        
        if (usuarioData) {
          usuarioActual = JSON.parse(usuarioData);
          console.log("Usuario cargado desde localStorage:", usuarioActual);
          actualizarInfoUsuario();
          return;
        }
        
        // Si no hay datos en localStorage, intentar obtenerlos del servidor
        const response = await fetch(`${API_URL}/api/usuario-actual`, {
          credentials: 'include'
        });
        
        if (!response.ok) {
          console.log('No se pudo obtener el usuario del servidor, redirigiendo al login');
          window.location.href = "login.html";
          return;
        }
        
        usuarioActual = await response.json();
        console.log("Usuario cargado desde el servidor:", usuarioActual);
        
        // Guardamos los datos en localStorage para futuras referencias
        localStorage.setItem('usuario', JSON.stringify(usuarioActual));
        
        actualizarInfoUsuario();
      } catch (error) {
        console.error("Error al cargar usuario:", error);
        setTimeout(() => {
          window.location.href = "login.html";
        }, 3000);
      }
    }

    function actualizarInfoUsuario() {
      if (!usuarioActual) return;
      
      // Actualizar la informaci√≥n en el header
      document.getElementById('userWelcome').textContent = `üë§ Bienvenido ${usuarioActual.nombre}`;
      
      // Actualizar la informaci√≥n en el modal
      document.getElementById('userName').textContent = usuarioActual.nombre || 'No disponible';
      document.getElementById('userEmail').textContent = usuarioActual.correo || 'No disponible';
      document.getElementById('userType').textContent = usuarioActual.tipo_usuario ? 
        (usuarioActual.tipo_usuario.charAt(0).toUpperCase() + usuarioActual.tipo_usuario.slice(1)) : 'No disponible';
    }

    // Toggle para el modal del men√∫
    function toggleModal() {
      const modal = document.getElementById("accountModal");
      
      if (modal.classList.contains('show')) {
        // Cerrar el modal
        modal.classList.remove("show");
        setTimeout(() => {
          modal.style.display = "none";
        }, 300); // Tiempo igual a la duraci√≥n de la transici√≥n
      } else {
        // Abrir el modal
        // Asegurarnos de tener la informaci√≥n m√°s actualizada
        actualizarInfoUsuario();
        
        modal.style.display = "block";
        // Peque√±o retardo para que la transici√≥n funcione
        setTimeout(() => {
          modal.classList.add("show");
        }, 10);
      }
    }

    // Funci√≥n para cargar asesor√≠as desde el servidor
    async function cargarAsesorias() {
      const contenedor = document.getElementById("asesorias-container");
      contenedor.innerHTML = '<p class="text-center">Cargando asesor√≠as...</p>';

      try {
        console.log("Intentando cargar asesor√≠as desde el servidor...");
        const response = await fetch('http://localhost:8000/api/asesorias', {
          headers: {
            'Content-Type': 'application/json',
          }
        });
        
        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(errorText || `Error ${response.status}`);
        }
        
        const data = await response.json();
        console.log("Asesor√≠as obtenidas:", data);
        
        if (!data || data.length === 0) {
          contenedor.innerHTML = '<p class="text-center">No hay asesor√≠as registradas a√∫n</p>';
          return;
        }
        
        // Guardar en variable global y localStorage
        asesorias = data;
        localStorage.setItem('asesoriasBackup', JSON.stringify(data));
        
        // Renderizar en pantalla
        renderizarAsesorias(data);
        
      } catch (error) {
        console.error("Error detallado al cargar asesor√≠as:", error);
        
        // Intenta con datos de localStorage
        const backup = localStorage.getItem('asesoriasBackup');
        if (backup) {
          try {
            console.log("Usando datos de respaldo del localStorage");
            const asesoriasBackup = JSON.parse(backup);
            asesorias = asesoriasBackup;
            renderizarAsesorias(asesoriasBackup);
            return;
          } catch (e) {
            console.error("Error al parsear backup:", e);
          }
        }
        
        // Muestra mensaje de error
        contenedor.innerHTML = `
          <div class="alert alert-danger">
            <p><strong>Error al cargar asesor√≠as:</strong> ${error.message}</p>
            <p>No se pudo conectar al servidor. Verifica que el servidor est√© funcionando en http://localhost:8000</p>
          </div>
        `;
      }
    }

    // Funci√≥n para renderizar las asesor√≠as en el DOM
    function renderizarAsesorias(asesorias) {
      const contenedor = document.getElementById("asesorias-container");
      contenedor.innerHTML = "";
      
      if (!asesorias || asesorias.length === 0) {
        contenedor.innerHTML = '<p class="text-center">No hay asesor√≠as registradas a√∫n</p>';
        return;
      }
      
      asesorias.forEach((a) => {
        console.log("Renderizando asesor√≠a:", a);
        const imagenUrl = a.imagen || 'https://via.placeholder.com/150?text=Sin+Imagen';
        
        contenedor.innerHTML += `
          <div class="card">
            <img src="${imagenUrl}" alt="${a.materia}" onerror="this.src='https://via.placeholder.com/150?text=Error'">
            <div class="card-info">
              <button class="delete-btn" onclick="eliminarAsesoria('${a._id}')">‚úï</button>
              <h3>${a.materia}</h3>
              <p><strong>Horario:</strong> ${a.dia} ${a.inicio} - ${a.fin}</p>
              <p><strong>Modalidad:</strong> ${a.modalidad}</p>
              <p><strong>Estado:</strong> ${a.estado || 'pendiente'}</p>
              ${a.descripcion ? `<p><strong>Descripci√≥n:</strong> ${a.descripcion}</p>` : ''}
            </div>
          </div>`;
      });
      
      // Actualizar el calendario cada vez que se renderizan las asesor√≠as
      renderizarCalendario();
    }
    
    // Funci√≥n para renderizar el calendario
    function renderizarCalendario() {
      const mesActual = new Date();
      const diasMes = new Date(mesActual.getFullYear(), mesActual.getMonth() + 1, 0).getDate();
      const primerDiaSemana = new Date(mesActual.getFullYear(), mesActual.getMonth(), 1).getDay();
      
      const grid = document.getElementById("calendar-grid");
      grid.innerHTML = "";

      const diasSemana = ['D', 'L', 'M', 'M', 'J', 'V', 'S'];
      for (let i = 0; i < diasSemana.length; i++) {
        grid.innerHTML += `<div class="day-name">${diasSemana[i]}</div>`;
      }

      // Espacios en blanco para los d√≠as antes del primer d√≠a del mes
      for (let i = 0; i < primerDiaSemana; i++) {
        grid.innerHTML += `<div></div>`;
      }

      // Obtener los d√≠as con asesor√≠as
      const diasConAsesorias = {};
      asesorias.forEach(a => {
        if (a.dia) {
          // Convertir nombre de d√≠a a n√∫mero
          const dias = {'Lunes': 1, 'Martes': 2, 'Miercoles': 3, 'Mi√©rcoles': 3, 'Jueves': 4, 'Viernes': 5, 'S√°bado': 6, 'Sabado': 6, 'Domingo': 0};
          const numeroDia = dias[a.dia];
          
          // Marcar todos los d√≠as de la semana que coincidan
          for (let d = 1; d <= diasMes; d++) {
            const diaSemana = (primerDiaSemana + d - 1) % 7;
            if (diaSemana === numeroDia) {
              diasConAsesorias[d] = true;
            }
          }
        }
      });

      // Generar el calendario
      for (let d = 1; d <= diasMes; d++) {
        const marcada = diasConAsesorias[d] ? 'marked' : '';
        grid.innerHTML += `<div class="day ${marcada}">${d}</div>`;
      }
    }

    // Funci√≥n para guardar una nueva asesor√≠a
    async function guardarAsesoria() {
      const modal = bootstrap.Modal.getInstance(document.getElementById('asesoriaModal'));
      try {
        const formData = new FormData();
        const imagenInput = document.getElementById('imagenInput');
        
        // Aseg√∫rate de que todos los campos requeridos est√©n presentes
        const materia = document.getElementById('materiaInput').value;
        const dia = document.getElementById('diaInput').value;
        const inicio = document.getElementById('inicioInput').value;
        const fin = document.getElementById('finInput').value;
        const modalidad = document.getElementById('modalidadInput').value;
        
        if (!materia || !dia || !inicio || !fin || !modalidad) {
          alert("Por favor complete todos los campos requeridos");
          return;
        }

        // Usar el mismo nombre de campos que espera el backend
        formData.append('ID_asesor', '1'); // Valor temporal
        formData.append('materia', materia);
        formData.append('descripcion', document.getElementById('descripcionInput').value);
        formData.append('modalidad', modalidad);
        formData.append('dia', dia);
        formData.append('inicio', inicio);
        formData.append('fin', fin);
        
        if (imagenInput.files[0]) {
          formData.append('imagen', imagenInput.files[0]);
        }

        console.log("Enviando datos al servidor...");
        const response = await fetch('http://localhost:8000/api/asesorias', {
          method: 'POST',
          body: formData,
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || errorData.message || 'Error al guardar');
        }
        
        const nuevaAsesoria = await response.json();
        console.log("Asesor√≠a creada:", nuevaAsesoria);
        
        // Actualizar la lista en memoria
        asesorias.unshift(nuevaAsesoria);
        localStorage.setItem('asesoriasBackup', JSON.stringify(asesorias));
        
        // Volver a renderizar la lista
        renderizarAsesorias(asesorias);
        
        // Limpiar y cerrar modal
        document.getElementById('asesoriaForm').reset();
        modal.hide();
        
        // Mostrar mensaje de √©xito
        const contenedor = document.getElementById("asesorias-container");
        contenedor.insertAdjacentHTML('afterbegin', `
          <div class="alert alert-success alert-dismissible fade show" role="alert">
            Asesor√≠a creada correctamente
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        `);
        
      } catch (error) {
        console.error('Error al guardar asesor√≠a:', error);
        alert(`Error al guardar: ${error.message}`);
      }
    }

    // Funci√≥n para eliminar una asesor√≠a
    async function eliminarAsesoria(id) {
      if (!confirm("¬øEst√°s seguro de que quieres eliminar esta asesor√≠a?")) return;
      
      try {
        console.log("Eliminando asesor√≠a con ID:", id);
        const response = await fetch(`http://localhost:8000/api/asesorias/${id}`, {
          method: 'DELETE'
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'Error al eliminar');
        }

        // Actualizar la lista en memoria
        asesorias = asesorias.filter(a => a._id !== id);
        localStorage.setItem('asesoriasBackup', JSON.stringify(asesorias));
        
        // Volver a renderizar la lista
        renderizarAsesorias(asesorias);
        
        // Mostrar mensaje de √©xito
        const contenedor = document.getElementById("asesorias-container");
        contenedor.insertAdjacentHTML('afterbegin', `
          <div class="alert alert-success alert-dismissible fade show" role="alert">
            Asesor√≠a eliminada correctamente
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        `);
        
      } catch (error) {
        console.error('Error al eliminar:', error);
        alert(`Error al eliminar: ${error.message}`);
      }
    }

    // Funci√≥n para mostrar/ocultar el buscador
    function mostrarBuscador() {
      const searchContainer = document.getElementById('searchContainer');
      searchContainer.style.display = searchContainer.style.display === 'none' ? 'block' : 'none';
    }

    // Funci√≥n para buscar asesor√≠as
    function buscarAsesoria() {
      const consulta = document.getElementById('searchInput').value.toLowerCase();
      if (!consulta) {
        renderizarAsesorias(asesorias);
        return;
      }
      
      const resultado = asesorias.filter(a => 
        a.materia.toLowerCase().includes(consulta) ||
        (a.descripcion && a.descripcion.toLowerCase().includes(consulta))
      );
      
      renderizarAsesorias(resultado);
    }
    
    // Funci√≥n para cerrar sesi√≥n
    function cerrarSesion() {
      // Borrar datos locales
      localStorage.removeItem('asesoriasBackup');
      localStorage.removeItem('usuario'); // Eliminar los datos del usuario
      
      // Intentar hacer logout en el servidor
      fetch(`${API_URL}/api/logout`, {
        method: 'POST',
        credentials: 'include'
      }).catch(error => {
        console.error("Error al cerrar sesi√≥n en el servidor:", error);
      }).finally(() => {
        // Redirigir a la p√°gina de login
        alert("Sesi√≥n cerrada. Redirigiendo al login...");
        window.location.href = "login.html";
      });
    }
  </script>
</body>
</html>