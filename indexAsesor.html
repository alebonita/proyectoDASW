<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Asesorías</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      margin: 0;
      padding: 0;
      background-color: white;
      font-family: Arial, sans-serif;
    }

    .header {
      background-color: #CE93D8;
      color: white;
      padding: 15px;
      font-size: 20px;
      font-weight: bold;
    }

    .container {
      padding: 20px;
      max-width: 800px;
      margin: 0 auto;
    }

    .title {
      font-size: 22px;
      font-weight: bold;
      color: #622C71;
      margin-bottom: 10px;
    }

    .buttons-container {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }

    .buttons-container button {
      background-color: #FFE699;
      border: none;
      border-radius: 50%;
      width: 35px;
      height: 35px;
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .card {
      display: flex;
      flex-direction: row; /* Explícitamente horizontal */
      background-color: #CE93D8;
      color: white;
      margin-bottom: 20px;
      border-radius: 8px;
      overflow: hidden;
      position: relative;
      min-height: 150px; /* Altura mínima para la tarjeta */
      box-shadow: 0 4px 8px rgba(0,0,0,0.1); /* Sombra suave */
    }

    .card img {
      width: 40%;
      height: 100%;
      object-fit: cover;
      flex-shrink: 0; /* Evita que la imagen se encoja */
    }

    .card-info {
      padding: 15px;
      width: 60%;
      text-align: left; /* Alineación izquierda explícita */
      display: flex;
      flex-direction: column;
      justify-content: center; /* Centra verticalmente el contenido */
    }

    .card-info h3 {
      color: #FFE699;
      margin: 0 0 5px 0;
    }

    .card-info p {
      margin: 2px 0;
    }

    .delete-btn {
      position: absolute;
      top: 5px;
      right: 5px;
      background-color: #ff5252;
      color: white;
      border: none;
      border-radius: 50%;
      width: 25px;
      height: 25px;
      font-size: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Estilos para el buscador */
    .search-container {
      margin-bottom: 15px;
    }

    .search-container input {
      padding: 8px;
      border-radius: 4px;
      border: 1px solid #ddd;
      width: 200px;
    }
  </style>
</head>
<body>
  <div class="header"> Bienvenido @asesor</div>

  <div class="container">
    <!-- Asesorías -->
    <div class="section">
      <div class="title">Asesorías</div>
      <div class="buttons-container">
        <button data-bs-toggle="modal" data-bs-target="#asesoriaModal">+</button>
        <button onclick="mostrarBuscador()">🔍</button>
      </div>
      <div class="search-container" id="searchContainer" style="display: none;">
        <input type="text" id="searchInput" placeholder="Buscar asesoría...">
        <button onclick="buscarAsesoria()">Buscar</button>
      </div>
      <div id="asesorias-container"></div>
    </div>
  </div>

  <!-- Modal para agregar asesorías -->
  <div class="modal fade" id="asesoriaModal" tabindex="-1" aria-labelledby="asesoriaModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="asesoriaModalLabel">Nueva Asesoría</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
        <div class="modal-body">
          <form id="asesoriaForm">
            <div class="mb-3">
              <label class="form-label">Materia</label>
              <input type="text" class="form-control" id="materiaInput" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Día</label>
              <select class="form-select" id="diaInput" required>
                <option value="Lunes">Lunes</option>
                <option value="Martes">Martes</option>
                <option value="Miercoles">Miércoles</option>
                <option value="Jueves">Jueves</option>
                <option value="Viernes">Viernes</option>
                <option value="Sábado">Sábado</option>
                <option value="Domingo">Domingo</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Hora de inicio</label>
              <input type="time" class="form-control" id="inicioInput" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Hora de fin</label>
              <input type="time" class="form-control" id="finInput" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Modalidad</label>
              <select class="form-select" id="modalidadInput" required>
                <option value="presencial">Presencial</option>
                <option value="virtual">Virtual</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Descripción</label>
              <textarea class="form-control" id="descripcionInput"></textarea>
            </div>
            <div class="mb-3">
              <label class="form-label">Imagen</label>
              <input type="file" class="form-control" id="imagenInput" accept="image/*">
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-primary" onclick="guardarAsesoria()">Guardar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS y dependencias -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    // Variable global para almacenar las asesorías
    let asesorias = [];
    let usuarioActual = null;

    // Cargar asesorías al iniciar la página
    document.addEventListener('DOMContentLoaded', async() => {
      try {
        await cargarUsuarioActual();
        await cargarAsesorias();
      } catch (error) {
        console.error("Error al inicializar:", error);
        alert("Error al inicializar la página. Verifica la conexión con el servidor.");
      }
    });

    async function cargarUsuarioActual() {
        try {
            const response = await fetch('http://localhost:8000/api/usuario-actual', {
                credentials: 'include'
            });
            
            if (!response.ok) {
                console.log('Usuario no autenticado, usando perfil predeterminado');
                document.querySelector('.header').textContent = '👤 Bienvenido Asesor';
                return;
            }
            
            usuarioActual = await response.json();
            actualizarHeader();
        } catch (error) {
            console.error("Error al cargar usuario:", error);
            document.querySelector('.header').textContent = '👤 Bienvenido Asesor';
        }
    }

    function actualizarHeader() {
        if (usuarioActual && usuarioActual.nombre) {
            const header = document.querySelector('.header');
            header.innerHTML = `👤 Bienvenido ${usuarioActual.nombre}`;
            
            // Opcional: agregar botón de cerrar sesión
            header.innerHTML += `
                <button onclick="cerrarSesion()" 
                        style="float: right; background: none; border: none; color: white; cursor: pointer;">
                    Cerrar sesión
                </button>`;
        }
    }

    // Función para cargar asesorías desde el servidor
    async function cargarAsesorias() {
      const contenedor = document.getElementById("asesorias-container");
      contenedor.innerHTML = '<p class="text-center">Cargando asesorías...</p>';

      try {
        console.log("Intentando cargar asesorías desde el servidor...");
        const response = await fetch('http://localhost:8000/api/asesorias', {
          headers: {
            'Content-Type': 'application/json',
          }
        });
        
        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(errorText || `Error ${response.status}`);
        }
        
        const data = await response.json();
        console.log("Asesorías obtenidas:", data);
        
        if (!data || data.length === 0) {
          contenedor.innerHTML = '<p class="text-center">No hay asesorías registradas aún</p>';
          return;
        }
        
        // Guardar en variable global y localStorage
        asesorias = data;
        localStorage.setItem('asesoriasBackup', JSON.stringify(data));
        
        // Renderizar en pantalla
        renderizarAsesorias(data);
        
      } catch (error) {
        console.error("Error detallado al cargar asesorías:", error);
        
        // Intenta con datos de localStorage
        const backup = localStorage.getItem('asesoriasBackup');
        if (backup) {
          try {
            console.log("Usando datos de respaldo del localStorage");
            const asesoriasBackup = JSON.parse(backup);
            asesorias = asesoriasBackup;
            renderizarAsesorias(asesoriasBackup);
            return;
          } catch (e) {
            console.error("Error al parsear backup:", e);
          }
        }
        
        // Muestra mensaje de error
        contenedor.innerHTML = `
          <div class="alert alert-danger">
            <p><strong>Error al cargar asesorías:</strong> ${error.message}</p>
            <p>No se pudo conectar al servidor. Verifica que el servidor esté funcionando en http://localhost:8000</p>
          </div>
        `;
      }
    }

    // Función para renderizar las asesorías en el DOM
    function renderizarAsesorias(asesorias) {
      const contenedor = document.getElementById("asesorias-container");
      contenedor.innerHTML = "";
      
      if (!asesorias || asesorias.length === 0) {
        contenedor.innerHTML = '<p class="text-center">No hay asesorías registradas aún</p>';
        return;
      }
      
      asesorias.forEach((a) => {
        console.log("Renderizando asesoría:", a);
        const imagenUrl = a.imagen || 'https://via.placeholder.com/150?text=Sin+Imagen';
        
        contenedor.innerHTML += `
          <div class="card">
            <img src="${imagenUrl}" alt="${a.materia}" onerror="this.src='https://via.placeholder.com/150?text=Error'">
            <div class="card-info">
              <button class="delete-btn" onclick="eliminarAsesoria('${a._id}')">✕</button>
              <h3>${a.materia}</h3>
              <p><strong>Horario:</strong> ${a.dia} ${a.inicio} - ${a.fin}</p>
              <p><strong>Modalidad:</strong> ${a.modalidad}</p>
              <p><strong>Estado:</strong> ${a.estado || 'pendiente'}</p>
              ${a.descripcion ? `<p><strong>Descripción:</strong> ${a.descripcion}</p>` : ''}
            </div>
          </div>`;
      });
    }

    // Función para guardar una nueva asesoría
    async function guardarAsesoria() {
      const modal = bootstrap.Modal.getInstance(document.getElementById('asesoriaModal'));
      try {
        const formData = new FormData();
        const imagenInput = document.getElementById('imagenInput');
        
        // Asegúrate de que todos los campos requeridos estén presentes
        const materia = document.getElementById('materiaInput').value;
        const dia = document.getElementById('diaInput').value;
        const inicio = document.getElementById('inicioInput').value;
        const fin = document.getElementById('finInput').value;
        const modalidad = document.getElementById('modalidadInput').value;
        
        if (!materia || !dia || !inicio || !fin || !modalidad) {
          alert("Por favor complete todos los campos requeridos");
          return;
        }

        // Usar el mismo nombre de campos que espera el backend
        formData.append('ID_asesor', '1'); // Valor temporal
        formData.append('materia', materia);
        formData.append('descripcion', document.getElementById('descripcionInput').value);
        formData.append('modalidad', modalidad);
        formData.append('dia', dia);
        formData.append('inicio', inicio);
        formData.append('fin', fin);
        
        if (imagenInput.files[0]) {
          formData.append('imagen', imagenInput.files[0]);
        }

        console.log("Enviando datos al servidor...");
        const response = await fetch('http://localhost:8000/api/asesorias', {
          method: 'POST',
          body: formData,
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || errorData.message || 'Error al guardar');
        }
        
        const nuevaAsesoria = await response.json();
        console.log("Asesoría creada:", nuevaAsesoria);
        
        // Actualizar la lista en memoria
        asesorias.unshift(nuevaAsesoria);
        localStorage.setItem('asesoriasBackup', JSON.stringify(asesorias));
        
        // Volver a renderizar la lista
        renderizarAsesorias(asesorias);
        
        // Limpiar y cerrar modal
        document.getElementById('asesoriaForm').reset();
        modal.hide();
        
        // Mostrar mensaje de éxito
        const contenedor = document.getElementById("asesorias-container");
        contenedor.insertAdjacentHTML('afterbegin', `
          <div class="alert alert-success alert-dismissible fade show" role="alert">
            Asesoría creada correctamente
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        `);
        
      } catch (error) {
        console.error('Error al guardar asesoría:', error);
        alert(`Error al guardar: ${error.message}`);
      }
    }

    // Función para eliminar una asesoría
    async function eliminarAsesoria(id) {
      if (!confirm("¿Estás seguro de que quieres eliminar esta asesoría?")) return;
      
      try {
        console.log("Eliminando asesoría con ID:", id);
        const response = await fetch(`http://localhost:8000/api/asesorias/${id}`, {
          method: 'DELETE'
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'Error al eliminar');
        }

        // Actualizar la lista en memoria
        asesorias = asesorias.filter(a => a._id !== id);
        localStorage.setItem('asesoriasBackup', JSON.stringify(asesorias));
        
        // Volver a renderizar la lista
        renderizarAsesorias(asesorias);
        
        // Mostrar mensaje de éxito
        const contenedor = document.getElementById("asesorias-container");
        contenedor.insertAdjacentHTML('afterbegin', `
          <div class="alert alert-success alert-dismissible fade show" role="alert">
            Asesoría eliminada correctamente
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        `);
        
      } catch (error) {
        console.error('Error al eliminar:', error);
        alert(`Error al eliminar: ${error.message}`);
      }
    }

    // Función para mostrar/ocultar el buscador
    function mostrarBuscador() {
      const searchContainer = document.getElementById('searchContainer');
      searchContainer.style.display = searchContainer.style.display === 'none' ? 'block' : 'none';
    }

    // Función para buscar asesorías
    function buscarAsesoria() {
      const consulta = document.getElementById('searchInput').value.toLowerCase();
      if (!consulta) {
        renderizarAsesorias(asesorias);
        return;
      }
      
      const resultado = asesorias.filter(a => 
        a.materia.toLowerCase().includes(consulta) ||
        (a.descripcion && a.descripcion.toLowerCase().includes(consulta))
      );
      
      renderizarAsesorias(resultado);
    }
  </script>
</body>
</html>